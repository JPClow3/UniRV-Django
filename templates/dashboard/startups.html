{% extends 'dashboard/base.html' %}
{% load humanize %}

{% block title %}Startups Incubadas - AgroHub{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div>
      <h1 class="text-gray-900 mb-2 text-2xl font-semibold">
        Startups Incubadas
      </h1>
      <p class="text-gray-600">
        {% if user.is_staff %}
          Gerencie as startups em processo de incubação na Ypetec
        {% else %}
          Conheça as startups incubadas no AgroHub
        {% endif %}
      </p>
    </div>
    {% if user.is_staff %}
      <a href="{% url 'dashboard_submeter_startup' %}" class="bg-gradient-to-r from-primary to-primary-hover hover:from-primary/90 hover:to-primary-hover/90 rounded-full shadow-md hover:shadow-lg transition-all inline-flex items-center justify-center gap-2 px-6 py-3 text-white font-medium">
        <i class="fas fa-plus w-4 h-4" aria-hidden="true"></i>
        Nova Startup
      </a>
    {% endif %}
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Total de startups incubadas">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        Total
        <i class="fas fa-question-circle text-gray-400 text-xs" aria-hidden="true"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.total|default:0 }}</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Fase Ideação">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        Ideação
        <i class="fas fa-question-circle text-gray-400 text-xs" aria-hidden="true"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.pre_incubacao|default:0 }}</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Fase MVP">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        MVP
        <i class="fas fa-question-circle text-gray-400 text-xs" aria-hidden="true"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.incubacao|default:0 }}</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Fase Escala">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        Escala
        <i class="fas fa-question-circle text-gray-400 text-xs" aria-hidden="true"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.graduada|default:0 }}</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Startups suspensas">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        Suspensas
        <i class="fas fa-question-circle text-gray-400 text-xs" aria-hidden="true"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.suspensa|default:0 }}</div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-xl border border-gray-200 p-4">
    <form method="GET" class="flex flex-col sm:flex-row gap-4">
      <div class="flex-1 relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" aria-hidden="true"></i>
        <input
          type="text"
          name="search"
          placeholder="Buscar startups..."
          class="pl-10 w-full"
          value="{{ search_query }}"
          aria-label="Buscar startups"
        >
      </div>

      <select name="edital" class="w-full sm:w-48" aria-label="Filtrar por edital">
        <option value="">Todos os editais</option>
        {% for edital in available_editais %}
        <option value="{{ edital.id }}" {% if edital_filter == edital.id|stringformat:"s" %}selected{% endif %}>
          {% if edital.numero_edital %}{{ edital.numero_edital }} - {% endif %}{{ edital.titulo|truncatewords:8 }}
        </option>
        {% empty %}
        <option value="" disabled>Nenhum edital disponível</option>
        {% endfor %}
      </select>

      <select name="status" class="w-full sm:w-48" aria-label="Filtrar por fase">
        <option value="">Todas as fases</option>
        <option value="Ideação" {% if status_filter|lower == 'ideação' %}selected{% endif %}>Ideação</option>
        <option value="MVP" {% if status_filter|lower == 'mvp' %}selected{% endif %}>MVP</option>
        <option value="Escala" {% if status_filter|lower == 'escala' %}selected{% endif %}>Escala</option>
        <option value="Suspensa" {% if status_filter|lower == 'suspensa' %}selected{% endif %}>Suspensa</option>
      </select>

      <select name="sort" class="w-full sm:w-48" aria-label="Ordenar por">
        <option value="submitted_on_desc" {% if sort_by == 'submitted_on_desc' %}selected{% endif %}>Data (mais recente)</option>
        <option value="submitted_on_asc" {% if sort_by == 'submitted_on_asc' %}selected{% endif %}>Data (mais antigo)</option>
        <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Nome (A-Z)</option>
        <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>Nome (Z-A)</option>
        <option value="status_asc" {% if sort_by == 'status_asc' %}selected{% endif %}>Fase</option>
      </select>
    </form>

  {% if search_query or edital_filter or status_filter %}
  <div class="mt-4 flex flex-wrap items-center gap-2 text-sm text-gray-600">
    <i class="fas fa-filter" aria-hidden="true"></i>
    <span class="font-medium">Filtros ativos:</span>
    {% if search_query %}
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">{{ search_query }}</span>
    {% endif %}
    {% if edital_filter %}
      {% for edital in available_editais %}
        {% if edital.id|stringformat:"s" == edital_filter %}
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">{{ edital.numero_edital|default:"Edital" }} {{ edital_filter }}</span>
        {% endif %}
      {% empty %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">Edital {{ edital_filter }}</span>
      {% endfor %}
    {% endif %}
    {% if status_filter %}
      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">{{ status_filter }}</span>
    {% endif %}
  </div>
  {% endif %}

  {% if startups|length == 0 %}
  <div class="mt-4 px-4 py-3 rounded-xl bg-blue-50 border border-blue-200 text-blue-800 flex gap-3 items-start">
    <i class="fas fa-info-circle mt-1" aria-hidden="true"></i>
    <div>
      <p class="font-semibold">Nenhuma startup encontrada com os filtros aplicados.</p>
      <p class="text-sm text-blue-700/80">Tente outros critérios de busca ou limpe os filtros para visualizar todas as startups.</p>
            <a href="{% url 'dashboard_startups' %}" class="inline-flex items-center gap-2 mt-3 px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition">
        <i class="fas fa-undo-alt text-xs" aria-hidden="true"></i>
        Limpar filtros
      </a>
    </div>
  </div>
  {% endif %}
  </div>

  <!-- Startups Cards -->
  {% if startups %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for startup in startups %}
    <div class="startup-card bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-all duration-200 hover:-translate-y-1 flex flex-col">
      <!-- Card Header -->
      <div class="flex items-start justify-between mb-4">
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">{{ startup.name }}</h3>
          {% if startup.edital %}
          <a href="{{ startup.edital.get_absolute_url }}" class="text-sm text-primary hover:text-primary-hover transition-colors inline-flex items-center gap-1">
            <i class="fas fa-file-alt text-xs" aria-hidden="true"></i>
            <span class="line-clamp-1">
              {% if startup.edital.numero_edital %}{{ startup.edital.numero_edital }} - {% endif %}
              {{ startup.edital.titulo|default:"Edital sem título" }}
            </span>
          </a>
          {% else %}
          <span class="text-sm text-gray-500 inline-flex items-center gap-1">
            <i class="fas fa-file-alt text-xs" aria-hidden="true"></i>
            Edital não disponível
          </span>
          {% endif %}
        </div>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium flex-shrink-0 ml-2 startup-phase-badge {% if startup.status == 'graduada' %}bg-green-100 text-green-700{% elif startup.status == 'incubacao' %}bg-blue-100 text-blue-700{% elif startup.status == 'suspensa' %}bg-red-100 text-red-700{% else %}bg-yellow-100 text-yellow-700{% endif %}">
          <i class="fas {% if startup.status == 'graduada' %}fa-rocket{% elif startup.status == 'incubacao' %}fa-tools{% elif startup.status == 'suspensa' %}fa-pause-circle{% else %}fa-lightbulb{% endif %} mr-1" aria-hidden="true"></i>
          {{ startup.get_phase_display }}
        </span>
      </div>

      <!-- Card Body -->
      <div class="flex-1 space-y-3 mb-4">
        {% if user.is_staff %}
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <i class="fas fa-user text-gray-400" aria-hidden="true"></i>
          {% if startup.proponente %}
          <span class="truncate">{{ startup.proponente.get_full_name|default:startup.proponente.username }}</span>
          {% else %}
          <span class="truncate">Usuário desconhecido</span>
          {% endif %}
        </div>
        {% endif %}

        <div class="flex items-center gap-2 text-sm text-gray-600">
          <i class="fas fa-calendar-alt text-gray-400" aria-hidden="true"></i>
          <span>
            {% if startup.submitted_on %}
              {{ startup.submitted_on|naturaltime }}
            {% else %}
              Data não disponível
            {% endif %}
          </span>
          {% if startup.data_atualizacao %}
          <span class="last-updated {% if startup.data_atualizacao >= recent_update_cutoff %}recent{% endif %}" title="Atualizado em {{ startup.data_atualizacao|date:'d/m/Y H:i' }}">
            <i class="fas fa-clock last-updated-icon text-xs" aria-hidden="true"></i>
            <span class="hidden sm:inline">Atualizado {{ startup.data_atualizacao|naturaltime }}</span>
          </span>
          {% endif %}
        </div>

      </div>

      <!-- Card Footer -->
      <div class="flex items-center justify-between pt-4 border-t border-gray-100">
        <div class="flex gap-2">
          {% if user.is_staff or startup.proponente == user %}
          <a href="{% url 'dashboard_startup_update' startup.pk %}" class="p-2 rounded-lg transition-all hover:bg-gray-100 text-gray-600 hover:text-blue-600" title="Editar startup" aria-label="Editar startup">
            <i class="fas fa-edit" aria-hidden="true"></i>
          </a>
          {% endif %}
          <button class="p-2 rounded-lg transition-all opacity-50 cursor-not-allowed" title="Em breve" aria-label="Visualizar startup (em breve)" disabled>
            <i class="fas fa-eye text-gray-400" aria-hidden="true"></i>
          </button>
        </div>
        <span class="text-xs text-gray-400">
          {% if startup.submitted_on %}
            {{ startup.submitted_on|date:"d/m/Y" }}
          {% else %}
            --
          {% endif %}
        </span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
    <!-- Rocket illustration -->
    <div class="empty-state-illustration mb-6 flex justify-center">
      <svg class="w-28 h-28 md:w-32 md:h-32" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="40" cy="50" r="3" fill="#22c55e" opacity="0.6"/>
        <circle cx="160" cy="40" r="2" fill="#2563EB" opacity="0.5"/>
        <circle cx="170" cy="80" r="3" fill="#22c55e" opacity="0.4"/>
        <circle cx="30" cy="120" r="2" fill="#2563EB" opacity="0.6"/>
        <path d="M100 30C100 30 130 60 130 100C130 140 100 170 100 170C100 170 70 140 70 100C70 60 100 30 100 30Z" fill="white" stroke="#2563EB" stroke-width="3"/>
        <circle cx="100" cy="85" r="15" fill="#2563EB"/>
        <circle cx="100" cy="85" r="10" fill="#60A5FA"/>
        <circle cx="96" cy="82" r="3" fill="white" opacity="0.6"/>
        <path d="M70 120L50 150L70 140Z" fill="#22c55e"/>
        <path d="M130 120L150 150L130 140Z" fill="#22c55e"/>
        <ellipse cx="100" cy="175" rx="15" ry="20" fill="#FCD34D"/>
        <ellipse cx="100" cy="172" rx="10" ry="15" fill="#F97316"/>
        <ellipse cx="100" cy="170" rx="5" ry="8" fill="#EF4444"/>
      </svg>
    </div>
    <div class="empty-state-icon mb-4">
      <i class="fas fa-folder-open text-3xl text-gray-400" aria-hidden="true"></i>
    </div>
    <h3 class="text-xl font-semibold text-gray-900 mb-2">Nenhuma startup encontrada</h3>
    <p class="text-gray-600 mb-6">Revise os filtros aplicados{% if user.is_staff %} ou cadastre uma nova startup{% endif %}.</p>
    <div class="flex flex-col sm:flex-row justify-center gap-3">
      {% if user.is_staff %}
      <a href="{% url 'dashboard_submeter_startup' %}" class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-primary to-primary-hover hover:from-primary/90 hover:to-primary-hover/90 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg">
        <i class="fas fa-plus" aria-hidden="true"></i>
        Nova Startup
      </a>
      {% endif %}
      <a href="{% url 'dashboard_startups' %}" class="inline-flex items-center gap-2 px-6 py-3 bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium transition-all">
        <i class="fas fa-undo-alt" aria-hidden="true"></i>
        Limpar filtros
      </a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
