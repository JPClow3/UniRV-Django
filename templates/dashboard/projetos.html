{% extends 'dashboard/base.html' %}
{% load humanize %}

{% block title %}{% if user.is_staff %}Projetos Submetidos{% else %}Meus Projetos{% endif %} - Dashboard AgroHub{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div>
      <h1 class="text-gray-900 mb-2 text-2xl font-semibold">
        {% if user.is_staff %}Projetos Submetidos{% else %}Meus Projetos{% endif %}
      </h1>
      <p class="text-gray-600">
        {% if user.is_staff %}
          Gerencie e avalie projetos submetidos aos editais
        {% else %}
          Acompanhe o status dos seus projetos
        {% endif %}
      </p>
    </div>
    {% if not user.is_staff %}
      <a href="{% url 'dashboard_submeter_projeto' %}" class="size-lg bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 rounded-full shadow-md hover:shadow-lg transition-all inline-flex items-center justify-center gap-2 px-6 py-3 text-white font-medium">
        <i class="fas fa-plus w-4 h-4"></i>
        Novo Projeto
      </a>
    {% endif %}
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Total de projetos submetidos">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        Total
        <i class="fas fa-question-circle text-gray-400 text-xs"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.total }}</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Projetos que estão sendo avaliados">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        Em Avaliação
        <i class="fas fa-question-circle text-gray-400 text-xs"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.em_avaliacao }}</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Projetos aprovados para incubação">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        Aprovados
        <i class="fas fa-question-circle text-gray-400 text-xs"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.aprovados }}</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:shadow-md transition-all" data-tooltip="Percentual de projetos aprovados em relação ao total">
      <div class="text-gray-600 mb-1 text-sm flex items-center gap-1">
        Taxa de Aprovação
        <i class="fas fa-question-circle text-gray-400 text-xs"></i>
      </div>
      <div class="text-gray-900 text-2xl font-bold">{{ stats.approval_rate }}</div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-xl border border-gray-200 p-4">
    <form method="GET" class="flex flex-col sm:flex-row gap-4">
      <div class="flex-1 relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
        <input
          type="text"
          name="search"
          placeholder="Buscar projetos..."
          class="pl-10 w-full"
          value="{{ search_query }}"
          aria-label="Buscar projetos"
        >
      </div>

      <select name="edital" class="w-full sm:w-48" aria-label="Filtrar por edital">
        <option value="">Todos os editais</option>
        {% for edital in available_editais %}
        <option value="{{ edital.id }}" {% if edital_filter == edital.id|stringformat:"s" %}selected{% endif %}>
          {% if edital.numero_edital %}{{ edital.numero_edital }} - {% endif %}{{ edital.titulo|truncatewords:8 }}
        </option>
        {% empty %}
        <option value="" disabled>Nenhum edital disponível</option>
        {% endfor %}
      </select>

      <select name="status" class="w-full sm:w-48" aria-label="Filtrar por status">
        <option value="">Todos</option>
        <option value="pendente" {% if status_filter == 'pendente' or status_filter == 'Pendente' %}selected{% endif %}>Pendente</option>
        <option value="em avaliação" {% if status_filter == 'em avaliação' or status_filter == 'Em Avaliação' %}selected{% endif %}>Em Avaliação</option>
        <option value="aprovado" {% if status_filter == 'aprovado' or status_filter == 'Aprovado' %}selected{% endif %}>Aprovado</option>
        <option value="reprovado" {% if status_filter == 'reprovado' or status_filter == 'Reprovado' %}selected{% endif %}>Reprovado</option>
      </select>

      <select name="sort" class="w-full sm:w-48" aria-label="Ordenar por">
        <option value="submitted_on_desc" {% if sort_by == 'submitted_on_desc' %}selected{% endif %}>Data (mais recente)</option>
        <option value="submitted_on_asc" {% if sort_by == 'submitted_on_asc' %}selected{% endif %}>Data (mais antigo)</option>
        <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Nome (A-Z)</option>
        <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>Nome (Z-A)</option>
        <option value="status_asc" {% if sort_by == 'status_asc' %}selected{% endif %}>Status</option>
        <option value="note_desc" {% if sort_by == 'note_desc' %}selected{% endif %}>Nota (maior)</option>
      </select>
    </form>

  {% if search_query or edital_filter or status_filter %}
  <div class="mt-4 flex flex-wrap items-center gap-2 text-sm text-gray-600">
    <i class="fas fa-filter"></i>
    <span class="font-medium">Filtros ativos:</span>
    {% if search_query %}
      <span class="badge bg-blue-100 text-blue-700 px-2 py-1 rounded">{{ search_query }}</span>
    {% endif %}
    {% if edital_filter %}
      {% for edital in available_editais %}
        {% if edital.id|stringformat:"s" == edital_filter %}
          <span class="badge bg-green-100 text-green-700 px-2 py-1 rounded">{{ edital.numero_edital|default:"Edital" }} {{ edital_filter }}</span>
        {% endif %}
      {% empty %}
        <span class="badge bg-green-100 text-green-700 px-2 py-1 rounded">Edital {{ edital_filter }}</span>
      {% endfor %}
    {% endif %}
    {% endif %}
    {% if status_filter %}
      <span class="badge bg-purple-100 text-purple-700 px-2 py-1 rounded">{{ status_filter }}</span>
    {% endif %}
  </div>
  {% endif %}

  {% if projects|length == 0 %}
  <div class="mt-4 px-4 py-3 rounded-xl bg-blue-50 border border-blue-200 text-blue-800 flex gap-3 items-start">
    <i class="fas fa-info-circle mt-1"></i>
    <div>
      <p class="font-semibold">Nenhum projeto encontrado com os filtros aplicados.</p>
      <p class="text-sm text-blue-700/80">Tente outros critérios de busca ou limpe os filtros para visualizar todos os projetos.</p>
      <a href="{% url 'dashboard_projetos' %}" class="inline-flex items-center gap-2 mt-3 px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition">
        <i class="fas fa-undo-alt text-xs"></i>
        Limpar filtros
      </a>
    </div>
  </div>
  {% endif %}
  </div>

  <!-- Projects Cards -->
  {% if projects %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for project in projects %}
    <div class="project-card bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-all duration-200 hover:-translate-y-1 flex flex-col">
      <!-- Card Header -->
      <div class="flex items-start justify-between mb-4">
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">{{ project.name }}</h3>
          <a href="{{ project.edital_url }}" class="text-sm text-unirvBlue hover:text-agrohubBlue transition-colors inline-flex items-center gap-1">
            <i class="fas fa-file-alt text-xs"></i>
            <span class="line-clamp-1">{{ project.edital_label }}</span>
          </a>
        </div>
        <span class="badge project-status-badge {% if project.status_value == 'aprovado' %}bg-green-100 text-green-700{% elif project.status_value == 'em_avaliacao' %}bg-blue-100 text-blue-700{% elif project.status_value == 'reprovado' %}bg-red-100 text-red-700{% else %}bg-yellow-100 text-yellow-700{% endif %} border-none px-3 py-1 text-xs font-medium flex-shrink-0 ml-2">
          <i class="fas {% if project.status_value == 'aprovado' %}fa-check-circle{% elif project.status_value == 'em_avaliacao' %}fa-clock{% elif project.status_value == 'reprovado' %}fa-times-circle{% else %}fa-hourglass-half{% endif %} mr-1"></i>
          {{ project.status }}
        </span>
      </div>

      <!-- Card Body -->
      <div class="flex-1 space-y-3 mb-4">
        {% if user.is_staff %}
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <i class="fas fa-user text-gray-400"></i>
          <span class="truncate">{{ project.proponente }}</span>
        </div>
        {% endif %}
        
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <i class="fas fa-calendar-alt text-gray-400"></i>
          <span>{{ project.submitted_on_relative }}</span>
          {% if project.updated_relative %}
          <span class="last-updated {% if project.is_recent_update %}recent{% endif %}" title="Atualizado em {{ project.updated_date_formatted }}">
            <i class="fas fa-clock last-updated-icon text-xs"></i>
            <span class="hidden sm:inline">Atualizado {{ project.updated_relative }}</span>
          </span>
          {% endif %}
        </div>

        {% if project.note %}
        <div class="flex items-center gap-2 text-sm">
          <i class="fas fa-star text-yellow-500"></i>
          <span class="font-semibold text-gray-900">{{ project.note }}</span>
          <span class="text-gray-500">/ 10</span>
        </div>
        {% endif %}
      </div>

      <!-- Card Footer -->
      <div class="flex items-center justify-between pt-4 border-t border-gray-100">
        <div class="flex gap-2">
          <button class="p-2 hover:bg-gray-100 rounded-lg transition-all hover:scale-110" title="Visualizar projeto" aria-label="Visualizar projeto">
            <i class="fas fa-eye text-gray-600 hover:text-unirvBlue"></i>
          </button>
          <button class="p-2 hover:bg-gray-100 rounded-lg transition-all hover:scale-110" title="Download" aria-label="Download do projeto">
            <i class="fas fa-download text-gray-600 hover:text-unirvBlue"></i>
          </button>
        </div>
        <span class="text-xs text-gray-400">{{ project.submitted_on }}</span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
    <div class="empty-state-icon mb-4">
      <i class="fas fa-folder-open text-6xl text-gray-300"></i>
    </div>
    <h3 class="text-xl font-semibold text-gray-900 mb-2">Nenhum projeto encontrado</h3>
    <p class="text-gray-600 mb-6">Revise os filtros aplicados ou cadastre um novo projeto.</p>
    <div class="flex flex-col sm:flex-row justify-center gap-3">
      {% if not user.is_staff %}
      <a href="{% url 'dashboard_submeter_projeto' %}" class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg">
        <i class="fas fa-plus"></i>
        Novo Projeto
      </a>
      {% endif %}
      <a href="{% url 'dashboard_projetos' %}" class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 rounded-lg font-medium transition-all">
        <i class="fas fa-undo-alt"></i>
        Limpar filtros
      </a>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

