{% extends 'dashboard/base.html' %}

{% block title %}Gerenciar Editais - Dashboard AgroHub{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div>
      <h1 class="text-gray-900 mb-2 text-2xl font-semibold">Gerenciar Editais</h1>
      <p class="text-gray-600">
        Crie, edite e publique editais de incubação e pré-incubação
      </p>
    </div>
    <a href="{% url 'edital_create' %}" class="bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 rounded-full shadow-md hover:shadow-lg transition-all inline-flex items-center justify-center gap-2 px-6 py-3 text-white font-medium">
      <i class="fas fa-plus w-4 h-4"></i>
      Novo Edital
    </a>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-gray-600 mb-1 text-sm">Total de Editais</div>
      <div class="text-gray-900 text-2xl font-bold">4</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-gray-600 mb-1 text-sm">Publicados</div>
      <div class="text-gray-900 text-2xl font-bold">2</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-gray-600 mb-1 text-sm">Rascunhos</div>
      <div class="text-gray-900 text-2xl font-bold">1</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-gray-600 mb-1 text-sm">Total de Submissões</div>
      <div class="text-gray-900 text-2xl font-bold">85</div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-xl border border-gray-200 p-4">
    <form method="GET" class="flex flex-col sm:flex-row gap-4">
      <div class="flex-1 relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
        <input
          type="text"
          name="search"
          placeholder="Buscar editais..."
          class="pl-10 w-full"
          value="{{ request.GET.search }}"
          aria-label="Buscar editais"
        >
      </div>

      <select name="tipo" class="w-full sm:w-48" aria-label="Filtrar por tipo">
        <option value="">Todos os tipos</option>
        <option value="Fluxo Contínuo" {% if request.GET.tipo == 'Fluxo Contínuo' %}selected{% endif %}>Fluxo Contínuo</option>
        <option value="Fomento" {% if request.GET.tipo == 'Fomento' %}selected{% endif %}>Fomento</option>
      </select>

      <select name="status" class="w-full sm:w-48" aria-label="Filtrar por status">
        <option value="">Todos</option>
        <option value="aberto" {% if request.GET.status == 'aberto' %}selected{% endif %}>Publicados</option>
        <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Rascunhos</option>
        <option value="fechado" {% if request.GET.status == 'fechado' %}selected{% endif %}>Encerrados</option>
      </select>
    </form>
    {% if request.GET.search or request.GET.tipo or request.GET.status %}
    <div class="mt-4 flex flex-wrap items-center gap-2 text-sm text-gray-600">
      <i class="fas fa-filter"></i>
      <span class="font-medium">Filtros ativos:</span>
      {% if request.GET.search %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">{{ request.GET.search }}</span>
      {% endif %}
      {% if request.GET.tipo %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">{{ request.GET.tipo }}</span>
      {% endif %}
      {% if request.GET.status %}
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">{{ request.GET.status|title }}</span>
      {% endif %}
    </div>
    {% endif %}

    {% if editais|length == 0 %}
    <div class="mt-4 px-4 py-3 rounded-xl bg-amber-50 border border-amber-200 text-amber-800 flex gap-3 items-start">
      <i class="fas fa-circle-info mt-1"></i>
      <div>
        <p class="font-semibold">Nenhum edital corresponde aos filtros atuais.</p>
        <p class="text-sm text-amber-700/80">Tente ajustar os parâmetros ou limpe os filtros para visualizar todos os registros.</p>
        <a href="{% url 'dashboard_editais' %}" class="inline-flex items-center gap-2 mt-3 px-3 py-1.5 rounded-lg bg-amber-600 text-white text-sm font-medium hover:bg-amber-700 transition">
          <i class="fas fa-undo-alt text-xs"></i>
          Limpar filtros
        </a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Editais Table (Desktop) -->
  <div class="hidden md:block">
    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-100 bg-white">
      <table class="hidden md:table min-w-full divide-y divide-gray-200" role="table" aria-label="Tabela de editais">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Número</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Título</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Tipo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Publicação</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Fechamento</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Submissões</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"></th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for edital in editais %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap font-mono text-sm">{{ edital.numero_edital|default:"-" }}</td>
              <td class="px-6 py-4 max-w-xs">
                <div class="flex items-center gap-2">
                  <i class="fas fa-file-alt text-gray-400 flex-shrink-0"></i>
                  <span class="truncate">{{ edital.titulo }}</span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-white border border-gray-300 text-gray-700">
                  {% if edital.end_date %}Fomento{% else %}Fluxo Contínuo{% endif %}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {% if edital.status == 'aberto' %}bg-green-100 text-green-700{% elif edital.status == 'draft' %}bg-gray-100 text-gray-700{% else %}bg-red-100 text-red-700{% endif %}">
                  {{ edital.get_status_display }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                {% if edital.start_date %}{{ edital.start_date|date:"d/m/Y" }}{% else %}-{% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                {% if edital.end_date %}{{ edital.end_date|date:"d/m/Y" }}{% else %}Sem prazo{% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-blue-600 font-medium">0</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="relative inline-block">
                  <button class="action-menu-toggle p-2 hover:bg-gray-100 rounded-lg transition-colors" data-id="{{ edital.id }}" aria-label="Menu de ações para {{ edital.titulo }}" aria-expanded="false">
                    <i class="fas fa-ellipsis-v text-gray-400"></i>
                  </button>
                  <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                    <a href="{{ edital.get_absolute_url }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                      <i class="fas fa-eye w-4 h-4"></i>
                      Visualizar
                    </a>
                    <a href="{% url 'edital_update' edital.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                      <i class="fas fa-edit w-4 h-4"></i>
                      Editar
                    </a>
                    <button type="button" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2 opacity-50 cursor-not-allowed" title="Em breve" aria-label="Ver Submissões (em breve)" disabled>
                      <i class="fas fa-calendar w-4 h-4"></i>
                      Ver Submissões
                    </button>
                    <a href="{% url 'edital_delete' edital.pk %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 delete-edital-link" data-edital-title="{{ edital.titulo }}">
                      <i class="fas fa-trash w-4 h-4"></i>
                      Excluir
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" class="px-6 py-12">
                {% include 'components/empty_state.html' with icon='fa-file-alt' title='Sem editais cadastrados' description='Crie um novo edital ou ajuste os filtros para visualizar registros existentes.' action_url_name='edital_create' action_text='Novo Edital' %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Editais Cards (Mobile) -->
  <div class="md:hidden space-y-4">
    {% for edital in editais %}
      <article class="project-card bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
        <div class="flex items-start justify-between mb-3 gap-3">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              {% if edital.numero_edital %}
                <span class="text-[11px] font-mono text-gray-500">#{{ edital.numero_edital }}</span>
              {% endif %}
            </div>
            <h3 class="text-sm font-semibold text-gray-900 leading-snug mb-1 line-clamp-2">
              {{ edital.titulo }}
            </h3>
            <div class="flex flex-wrap items-center gap-2 mt-1">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-100 text-gray-700">
                {% if edital.end_date %}Fomento{% else %}Fluxo Contínuo{% endif %}
              </span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium
                {% if edital.status == 'aberto' %}bg-green-100 text-green-700
                {% elif edital.status == 'draft' %}bg-gray-100 text-gray-700
                {% else %}bg-red-100 text-red-700{% endif %}">
                {{ edital.get_status_display }}
              </span>
            </div>
          </div>
        </div>

        <div class="text-xs text-gray-600 space-y-1 mb-3">
          <div class="flex items-center gap-2">
            <i class="fas fa-calendar-alt text-gray-400"></i>
            <span>
              Publicação:
              {% if edital.start_date %}
                <span class="font-medium text-gray-900">{{ edital.start_date|date:"d/m/Y" }}</span>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </span>
          </div>
          <div class="flex items-center gap-2">
            <i class="fas fa-clock text-gray-400"></i>
            <span>
              Fechamento:
              {% if edital.end_date %}
                <span class="font-medium text-gray-900">{{ edital.end_date|date:"d/m/Y" }}</span>
              {% else %}
                <span class="text-gray-400">Sem prazo</span>
              {% endif %}
            </span>
          </div>
        </div>

        <div class="flex items-center justify-between pt-2 border-t border-gray-100">
          <a href="{{ edital.get_absolute_url }}" class="inline-flex items-center gap-2 text-xs font-semibold text-unirvBlue hover:text-agrohubBlue">
            <i class="fas fa-eye text-[11px]"></i>
            Ver detalhes
          </a>
          <div class="flex items-center gap-1">
            <a href="{% url 'edital_update' edital.pk %}" class="p-1.5 rounded-lg text-xs text-gray-500 hover:text-unirvBlue hover:bg-gray-100" aria-label="Editar edital">
              <i class="fas fa-edit"></i>
            </a>
          </div>
        </div>
      </article>
    {% empty %}
      <div class="px-2">
        {% include 'components/empty_state.html' with icon='fa-file-alt' title='Sem editais cadastrados' description='Crie um novo edital ou ajuste os filtros para visualizar registros existentes.' action_url_name='edital_create' action_text='Novo Edital' %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const menuToggles = document.querySelectorAll('.action-menu-toggle');
  
  menuToggles.forEach(toggle => {
    toggle.addEventListener('click', function(e) {
      e.stopPropagation();
      const menu = this.nextElementSibling;
      const isOpen = !menu.classList.contains('hidden');
      
      // Close all menus
      document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
      
      // Toggle current menu
      if (!isOpen) {
        menu.classList.remove('hidden');
      }
    });
  });
  
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.action-menu-toggle') && !e.target.closest('.action-menu')) {
      document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
    }
  });

  // Delete confirmation
  document.querySelectorAll('.delete-edital-link').forEach(link => {
    link.addEventListener('click', async function(e) {
      e.preventDefault();
      const editalTitle = this.getAttribute('data-edital-title');
      const deleteUrl = this.getAttribute('href');
      
      // Escape the edital title to prevent XSS attacks
      // Note: Django already HTML-escapes the value, but we escape again for JS string context
      const escapedTitle = escapeJsString(editalTitle || '');
      
      const confirmed = await showConfirmDialog({
        title: 'Confirmar Exclusão',
        message: `Tem certeza que deseja excluir o edital "${escapedTitle}"? Esta ação não pode ser desfeita e todos os dados relacionados serão permanentemente removidos.`,
        confirmText: 'Excluir',
        cancelText: 'Cancelar',
        type: 'danger',
        confirmButtonClass: 'btn-danger'
      });
      
      if (confirmed) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = deleteUrl;
        
        // Get CSRF token from cookie or meta tag
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                         getCookie('csrftoken');
        if (csrfToken) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
      }
    });
  });
});
</script>
{% endblock %}

