{% extends 'dashboard/base.html' %}

{% block title %}Gerenciar Editais - Dashboard AgroHub{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <div>
      <h1 class="text-gray-900 mb-2 text-2xl font-semibold">Gerenciar Editais</h1>
      <p class="text-gray-600">
        Crie, edite e publique editais de incubação e pré-incubação
      </p>
    </div>
    <a href="{% url 'dashboard_novo_edital' %}" class="size-lg bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 rounded-full shadow-md hover:shadow-lg transition-all inline-flex items-center justify-center gap-2 px-6 py-3 text-white font-medium">
      <i class="fas fa-plus w-4 h-4"></i>
      Novo Edital
    </a>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-gray-600 mb-1 text-sm">Total de Editais</div>
      <div class="text-gray-900 text-2xl font-bold">4</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-gray-600 mb-1 text-sm">Publicados</div>
      <div class="text-gray-900 text-2xl font-bold">2</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-gray-600 mb-1 text-sm">Rascunhos</div>
      <div class="text-gray-900 text-2xl font-bold">1</div>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <div class="text-gray-600 mb-1 text-sm">Total de Submissões</div>
      <div class="text-gray-900 text-2xl font-bold">85</div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-xl border border-gray-200 p-4">
    <form method="GET" class="flex flex-col sm:flex-row gap-4">
      <div class="flex-1 relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
        <input
          type="text"
          name="search"
          placeholder="Buscar editais..."
          class="pl-10 w-full"
          value="{{ request.GET.search }}"
          aria-label="Buscar editais"
        >
      </div>

      <select name="tipo" class="w-full sm:w-48" aria-label="Filtrar por tipo">
        <option value="">Todos os tipos</option>
        <option value="Fluxo Contínuo" {% if request.GET.tipo == 'Fluxo Contínuo' %}selected{% endif %}>Fluxo Contínuo</option>
        <option value="Fomento" {% if request.GET.tipo == 'Fomento' %}selected{% endif %}>Fomento</option>
      </select>

      <select name="status" class="w-full sm:w-48" aria-label="Filtrar por status">
        <option value="">Todos</option>
        <option value="aberto" {% if request.GET.status == 'aberto' %}selected{% endif %}>Publicados</option>
        <option value="draft" {% if request.GET.status == 'draft' %}selected{% endif %}>Rascunhos</option>
        <option value="fechado" {% if request.GET.status == 'fechado' %}selected{% endif %}>Encerrados</option>
      </select>
    </form>
    {% if request.GET.search or request.GET.tipo or request.GET.status %}
    <div class="mt-4 flex flex-wrap items-center gap-2 text-sm text-gray-600">
      <i class="fas fa-filter"></i>
      <span class="font-medium">Filtros ativos:</span>
      {% if request.GET.search %}
        <span class="badge bg-blue-100 text-blue-700 px-2 py-1 rounded">{{ request.GET.search }}</span>
      {% endif %}
      {% if request.GET.tipo %}
        <span class="badge bg-green-100 text-green-700 px-2 py-1 rounded">{{ request.GET.tipo }}</span>
      {% endif %}
      {% if request.GET.status %}
        <span class="badge bg-purple-100 text-purple-700 px-2 py-1 rounded">{{ request.GET.status|title }}</span>
      {% endif %}
    </div>
    {% endif %}

    {% if editais|length == 0 %}
    <div class="mt-4 px-4 py-3 rounded-xl bg-amber-50 border border-amber-200 text-amber-800 flex gap-3 items-start">
      <i class="fas fa-circle-info mt-1"></i>
      <div>
        <p class="font-semibold">Nenhum edital corresponde aos filtros atuais.</p>
        <p class="text-sm text-amber-700/80">Tente ajustar os parâmetros ou limpe os filtros para visualizar todos os registros.</p>
        <a href="{% url 'dashboard_editais' %}" class="inline-flex items-center gap-2 mt-3 px-3 py-1.5 rounded-lg bg-amber-600 text-white text-sm font-medium hover:bg-amber-700 transition">
          <i class="fas fa-undo-alt text-xs"></i>
          Limpar filtros
        </a>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Editais Table -->
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="table-responsive overflow-x-auto">
      <table class="w-full" role="table" aria-label="Tabela de editais">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Número</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Título</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Tipo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Publicação</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Fechamento</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Submissões</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"></th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for edital in editais %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap font-mono text-sm">{{ edital.numero_edital|default:"-" }}</td>
              <td class="px-6 py-4 max-w-xs">
                <div class="flex items-center gap-2">
                  <i class="fas fa-file-alt text-gray-400 flex-shrink-0"></i>
                  <span class="truncate">{{ edital.titulo }}</span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="badge bg-white border border-gray-300 text-gray-700 px-3 py-1 text-sm rounded">
                  {% if edital.end_date %}Fomento{% else %}Fluxo Contínuo{% endif %}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="badge {% if edital.status == 'aberto' %}bg-green-100 text-green-700{% elif edital.status == 'draft' %}bg-gray-100 text-gray-700{% else %}bg-red-100 text-red-700{% endif %} border-none px-3 py-1 text-sm">
                  {{ edital.get_status_display }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                {% if edital.start_date %}{{ edital.start_date|date:"d/m/Y" }}{% else %}-{% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                {% if edital.end_date %}{{ edital.end_date|date:"d/m/Y" }}{% else %}Sem prazo{% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-blue-600 font-medium">0</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="relative inline-block">
                  <button class="action-menu-toggle p-2 hover:bg-gray-100 rounded-lg transition-colors" data-id="{{ edital.id }}">
                    <i class="fas fa-ellipsis-v text-gray-400"></i>
                  </button>
                  <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                    <a href="{{ edital.get_absolute_url }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                      <i class="fas fa-eye w-4 h-4"></i>
                      Visualizar
                    </a>
                    <a href="{% url 'edital_update' edital.pk %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                      <i class="fas fa-edit w-4 h-4"></i>
                      Editar
                    </a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                      <i class="fas fa-calendar w-4 h-4"></i>
                      Ver Submissões
                    </a>
                    <a href="{% url 'edital_delete' edital.pk %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2" onclick="return confirm('Tem certeza que deseja excluir este edital?')">
                      <i class="fas fa-trash w-4 h-4"></i>
                      Excluir
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" class="px-6 py-10">
                <div class="empty-state-table text-center">
                  <div class="empty-state-icon">
                    <i class="fas fa-folder-open"></i>
                  </div>
                  <h3>Sem editais cadastrados</h3>
                  <p>Crie um novo edital ou ajuste os filtros para visualizar registros existentes.</p>
                  <div class="flex justify-center gap-3 mt-4">
                    <a href="{% url 'dashboard_novo_edital' %}" class="btn bg-gradient-to-r from-green-500 to-blue-600 text-white">
                      Novo Edital
                    </a>
                    <a href="{% url 'dashboard_editais' %}" class="btn bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 rounded-lg px-4 py-2 text-sm transition-all inline-flex items-center justify-center">
                      Limpar filtros
                    </a>
                  </div>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const menuToggles = document.querySelectorAll('.action-menu-toggle');
  
  menuToggles.forEach(toggle => {
    toggle.addEventListener('click', function(e) {
      e.stopPropagation();
      const menu = this.nextElementSibling;
      const isOpen = !menu.classList.contains('hidden');
      
      // Close all menus
      document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
      
      // Toggle current menu
      if (!isOpen) {
        menu.classList.remove('hidden');
      }
    });
  });
  
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.action-menu-toggle') && !e.target.closest('.action-menu')) {
      document.querySelectorAll('.action-menu').forEach(m => m.classList.add('hidden'));
    }
  });
});
</script>
{% endblock %}

