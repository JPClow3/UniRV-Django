{% extends 'base.html' %}
{% load editais_filters humanize %}

{% block title %}{{ edital.titulo }} - AgroHub UniRV{% endblock %}


{% block meta_description %}{{ edital.objetivo|truncatewords:30|striptags }} - Edital de fomento {% if edital.entidade_principal %}pela {{ edital.entidade_principal }}{% endif %}. Status: {{ edital.get_status_display }}.{% endblock %}

{% block og_title %}{{ edital.titulo }}{% endblock %}

{% block og_description %}{{ edital.objetivo|truncatewords:25|striptags }}{% endblock %}

{% block content %}
<style>
  /* Optimize animations to reduce forced reflows */
  .reveal-up,
  .bg-white.rounded-xl {
    will-change: transform, opacity;
  }
  /* Remove will-change after animation to free up resources */
  .reveal-up.animated,
  .bg-white.rounded-xl.animated {
    will-change: auto;
  }
</style>
<!-- Hero Header -->
<section class="bg-gradient-to-r from-unirvBlue to-agrohubBlue text-white py-8 md:py-10 relative overflow-hidden">
  <div class="container relative z-10 px-6 pt-12">
    <div class="max-w-6xl">
      <div class="reveal-up inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 border border-white/20 backdrop-blur-md text-white/90 text-xs font-bold uppercase tracking-wider mb-6">
        <span class="w-2 h-2 rounded-full bg-agrohubGreen animate-pulse"></span>
        Edital
      </div>
      <h1 class="reveal-up text-4xl md:text-6xl font-extrabold text-white leading-tight mb-4">{{ edital.titulo }}</h1>
      {% if edital.objetivo %}
      <p class="reveal-up text-lg md:text-xl text-gray-200 mb-6 leading-relaxed border-l-4 border-agrohubGreen pl-6">
        {{ edital.objetivo|striptags|truncatewords:30 }}
      </p>
      {% else %}
      <p class="reveal-up text-lg md:text-xl text-gray-200 mb-6 leading-relaxed border-l-4 border-agrohubGreen pl-6">
        Confira os detalhes completos deste edital e as oportunidades disponíveis.
      </p>
      {% endif %}
      <div class="flex flex-wrap gap-4 text-white/90 text-sm items-center">
        {% if edital.numero_edital %}
        <span class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full hover:bg-white/20 transition-colors">
          <i class="fas fa-file-alt" aria-hidden="true"></i>
          Edital {{ edital.numero_edital }}
        </span>
        {% endif %}
        <span class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full hover:bg-white/20 transition-colors">
          <i class="fas fa-tag" aria-hidden="true"></i>
          {{ edital.get_status_display }}
        </span>
        {% if edital.entidade_principal %}
        <span class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full hover:bg-white/20 transition-colors">
          <i class="fas fa-building" aria-hidden="true"></i>
          {{ edital.entidade_principal }}
        </span>
        {% endif %}
        {% if edital.data_atualizacao %}
        <span class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full hover:bg-white/20 transition-colors last-updated {% if is_recent_update %}recent{% endif %}" title="Atualizado em {{ edital.data_atualizacao|date:'d/m/Y H:i' }}">
          <i class="fas fa-clock" aria-hidden="true"></i>
          <span>Atualizado {{ edital.data_atualizacao|timesince }} atrás</span>
        </span>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="max-w-6xl mx-auto">
  <div class="mb-4 flex justify-end no-print">
    <button type="button" id="print-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all">
      <i class="fas fa-print"></i>
      Imprimir
    </button>
  </div>

<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-8 border border-gray-100">
    <h2 class="text-unirvBlue text-xl font-bold mb-4">Informações do Edital</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% if edital.start_date %}
        <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-calendar-alt text-green-600" aria-hidden="true"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Abertura</p>
                <time datetime="{{ edital.start_date|date:'Y-m-d' }}" class="text-gray-900 font-semibold">{{ edital.start_date|date:"d/m/Y" }}</time>
            </div>
        </div>
        {% endif %}
        {% if edital.end_date %}
        <div class="flex items-center gap-3 p-4 {% if edital.end_date|is_deadline_soon %}bg-red-50 border border-red-200{% else %}bg-gray-50{% endif %} rounded-xl">
            <div class="w-10 h-10 {% if edital.end_date|is_deadline_soon %}bg-red-100{% else %}bg-orange-100{% endif %} rounded-lg flex items-center justify-center">
                <i class="fas fa-calendar-times {% if edital.end_date|is_deadline_soon %}text-red-600{% else %}text-orange-600{% endif %}" aria-hidden="true"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Encerramento</p>
                <time datetime="{{ edital.end_date|date:'Y-m-d' }}" class="text-gray-900 font-semibold">{{ edital.end_date|date:"d/m/Y" }}</time>
                {% if edital.end_date|is_deadline_soon %}
                <span class="text-red-600 text-xs font-medium block" aria-label="Prazo próximo">
                    <i class="fas fa-clock" aria-hidden="true"></i> Prazo próximo
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-sync-alt text-blue-600" aria-hidden="true"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Atualizado</p>
                <time datetime="{{ edital.data_atualizacao|date:'Y-m-d' }}" class="text-gray-900 font-semibold">{{ edital.data_atualizacao|date:"d/m/Y" }}</time>
            </div>
        </div>
    </div>
</div>


{% if edital.objetivo_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="objetivo">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">1</span>
    Objetivo do Edital
  </h3>
  {# SECURITY NOTE: objetivo_safe should be sanitized on the server side using bleach or similar #}
  {# to prevent XSS attacks. Ensure mark_safe is only used after proper HTML sanitization. #}
  <div class="prose">{{ edital.objetivo_safe }}</div>
</div>
{% endif %}

{% if edital.etapas_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="etapas">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">2</span>
    Etapas do Edital
  </h3>
  {# SECURITY NOTE: All _safe fields should be sanitized server-side before mark_safe #}
  <div class="prose">{{ edital.etapas_safe }}</div>
</div>
{% endif %}

{% if edital.recursos_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="recursos-financeiros">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">3</span>
    Cronograma / Recursos
  </h3>
  <div class="prose">{{ edital.recursos_safe }}</div>
</div>
{% endif %}

{% if edital.itens_financiaveis_safe or edital.criterios_elegibilidade_safe or edital.criterios_avaliacao_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="itens-financiaveis">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">4</span>
    Itens Financiáveis / Elegibilidade / Avaliação
  </h3>
  {% if edital.itens_financiaveis_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Itens Financiáveis</h4>
    <div class="prose">{{ edital.itens_financiaveis_safe }}</div>
  {% endif %}
  {% if edital.criterios_elegibilidade_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Critérios de Elegibilidade</h4>
    <div class="prose">{{ edital.criterios_elegibilidade_safe }}</div>
  {% endif %}
  {% if edital.criterios_avaliacao_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Critérios de Avaliação</h4>
    <div class="prose">{{ edital.criterios_avaliacao_safe }}</div>
  {% endif %}
</div>
{% endif %}

{% if edital.itens_essenciais_observacoes_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="itens-essenciais">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">5</span>
    Itens Essenciais / Observações
  </h3>
  <div class="prose">{{ edital.itens_essenciais_observacoes_safe }}</div>
</div>
{% endif %}

{% if edital.detalhes_unirv_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="pontos-unirv">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">6</span>
    Pontos para a UniRV
  </h3>
  <div class="prose">{{ edital.detalhes_unirv_safe }}</div>
</div>
{% endif %}

    {% if edital.created_by or edital.updated_by %}
        <div class="activity-info">
            {% if edital.created_by %}
                <span class="created-by">
        <i class="fas fa-user-plus" aria-hidden="true"></i>
        Criado por <strong>{{ edital.created_by.username }}</strong> em {{ edital.data_criacao|date:"d/m/Y H:i" }}
    </span>
            {% endif %}
            {% if edital.updated_by and edital.updated_by != edital.created_by %}
                <span class="updated-by">
        <i class="fas fa-user-edit" aria-hidden="true"></i>
        Última atualização por <strong>{{ edital.updated_by.username }}</strong>
    </span>
            {% endif %}
        </div>
    {% endif %}

<p class="disclaimer">
    <i class="fas fa-info-circle" aria-hidden="true"></i>
    Consulte o edital oficial para detalhes completos.
</p>

<div class="flex flex-wrap gap-3 mt-8">
  {% include "components/button.html" with href=edital.url type="primary" icon="fas fa-external-link-alt" slot="Acessar Edital" attrs='target="_blank" rel="noopener noreferrer"' %}
  
  {% if user.is_authenticated and user.is_staff %}
    {% url 'edital_update' edital.pk as update_url %}
    {% include "components/button.html" with href=update_url type="secondary" icon="fas fa-edit" slot="Editar" %}
  {% endif %}
  
  {% url 'editais_index' as index_url %}
  {% include "components/button.html" with href=index_url type="outline" icon="fas fa-arrow-left" slot="Voltar" %}
</div>

{% if user.is_authenticated and user.is_staff %}
{% with history_entries=edital.history.all %}
{% if history_entries %}
<div class="history-section">
    <h3>Histórico de Alterações</h3>
    <div class="history-list">
        {% for entry in history_entries|slice:":10" %}
        <div class="history-item">
            <div class="history-header">
                <span class="history-action history-{{ entry.action }}">{{ entry.get_action_display }}</span>
                <span class="history-user">por {{ entry.user.username|default:"Sistema" }}</span>
                <time class="history-time" datetime="{{ entry.timestamp|date:'Y-m-d H:i' }}">
                    {{ entry.timestamp|date:"d/m/Y H:i" }}
                </time>
            </div>
            {% if entry.changes_summary %}
            <div class="history-changes">
                {% for field, values in entry.changes_summary.items %}
                <div class="history-change-item">
                    <strong>{{ field|title }}:</strong>
                    <span class="old-value">{{ values.old|truncatewords:10 }}</span>
                    <i class="fas fa-arrow-right" aria-hidden="true"></i>
                    <span class="new-value">{{ values.new|truncatewords:10 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endwith %}
{% endif %}

  </div><!-- end max-w-6xl -->
</div><!-- end container -->
{% endblock %}

{% block extra_js %}
<script>
// Optimized animations for detail page - using GSAP loaded from base.html with defer
// This code runs after GSAP is loaded, reducing forced reflows
(function() {
    'use strict';
    
    // Wait for GSAP to be available (loaded with defer in base.html)
    function initAnimations() {
        if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
            // Retry after a short delay if GSAP isn't loaded yet
            setTimeout(initAnimations, 50);
            return;
        }

        gsap.registerPlugin(ScrollTrigger);

        // Batch DOM reads to reduce forced reflows
        const headerSection = document.querySelector('section.bg-gradient-to-r');
        const headerRevealElements = headerSection ? headerSection.querySelectorAll('.reveal-up') : [];
        const contentSections = document.querySelectorAll('.bg-white.rounded-xl');
        
        // Use requestAnimationFrame to batch DOM writes
        requestAnimationFrame(function() {
            // 1. Animate header elements immediately on load
            if (headerRevealElements.length > 0) {
                // Set initial state in a single batch
                gsap.set(headerRevealElements, { y: 20, opacity: 0 });
                
                // Animate with will-change optimization (handled by CSS)
                gsap.to(headerRevealElements, {
                    y: 0,
                    opacity: 1,
                    duration: 0.5,
                    stagger: 0.08,
                    ease: "power3.out",
                    delay: 0.05,
                    force3D: true, // Use GPU acceleration
                    onComplete: function() {
                        // Remove will-change after animation to free up resources
                        headerRevealElements.forEach(function(el) {
                            el.classList.add('animated');
                        });
                    }
                });
            }

            // 2. Animate content sections immediately or very early on scroll
            if (contentSections.length > 0) {
                // Set initial state in batch
                gsap.set(contentSections, { opacity: 0, y: 30 });
                
                // Animate immediately without waiting for scroll - show details fast
                contentSections.forEach(function(section, index) {
                    gsap.to(section, {
                        opacity: 1,
                        y: 0,
                        duration: 0.3,
                        ease: "power2.out",
                        delay: index * 0.05,
                        force3D: true, // Use GPU acceleration
                        onComplete: function() {
                            // Remove will-change after animation to free up resources
                            section.classList.add('animated');
                        }
                    });
                });
            }
        });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAnimations);
    } else {
        // DOM already loaded, but wait for GSAP
        initAnimations();
    }

    // Print button functionality (doesn't require GSAP)
    const printBtn = document.getElementById('print-btn');
    if (printBtn) {
        printBtn.addEventListener('click', function() {
            window.print();
        });
    }
})();
</script>
{% endblock %}
