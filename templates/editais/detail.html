{% extends 'base.html' %}
{% load editais_filters %}

{% block title %}{{ edital.titulo }} - AgroHub UniRV{% endblock %}

{% block breadcrumb %}
{% include 'editais/breadcrumb.html' %}
{% block breadcrumb_items %}
<li class="breadcrumb-item" aria-current="page">
    <span>{{ edital.titulo|truncatewords:8 }}</span>
</li>
{% endblock %}
{% endblock %}

{% block meta_description %}{{ edital.objetivo|truncatewords:30|striptags }} - Edital de fomento {% if edital.entidade_principal %}pela {{ edital.entidade_principal }}{% endif %}. Status: {{ edital.get_status_display }}.{% endblock %}

{% block og_title %}{{ edital.titulo }}{% endblock %}

{% block og_description %}{{ edital.objetivo|truncatewords:25|striptags }}{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        {% csrf_token %}
    {% endif %}

<div class="bg-white p-6 rounded-xl shadow-sm mb-8">
    <div class="page-header-top">
        <h1 class="text-unirvBlue text-3xl font-bold leading-tight mb-4">{{ edital.titulo }}</h1>
    </div>
    <div class="flex flex-wrap gap-5 mt-4 pt-4 border-t border-gray-200">
        {% if edital.numero_edital %}
        <span class="flex items-center gap-2 text-sm text-gray-700">
            <i class="fas fa-file-alt text-unirvBlue" aria-hidden="true"></i>
            <strong class="text-unirvBlue font-semibold">Nº:</strong> {{ edital.numero_edital }}
        </span>
        {% endif %}
        {% if edital.entidade_principal %}
        <span class="flex items-center gap-2 text-sm text-gray-700">
            <i class="fas fa-building text-unirvBlue" aria-hidden="true"></i>
            <strong class="text-unirvBlue font-semibold">Entidade:</strong> {{ edital.entidade_principal }}
        </span>
        {% endif %}
        <span class="flex items-center gap-2 text-sm text-gray-700">
            <i class="fas fa-tag text-unirvBlue" aria-hidden="true"></i>
            <strong class="text-unirvBlue font-semibold">Status:</strong> <span class="status-badge status-{{ edital.status }}">{{ edital.get_status_display }}</span>
        </span>
        {% if edital.start_date %}
        <span class="flex items-center gap-2 text-sm text-gray-700">
            <i class="fas fa-calendar-alt text-unirvBlue" aria-hidden="true"></i>
            <strong class="text-unirvBlue font-semibold">Abertura:</strong> <time datetime="{{ edital.start_date|date:'Y-m-d' }}">{{ edital.start_date|date:"d/m/Y" }}</time>
        </span>
        {% endif %}
        {% if edital.end_date %}
        <span class="flex items-center gap-2 text-sm text-gray-700 {% if edital.end_date|is_deadline_soon %}bg-red-50 px-3 py-2 rounded-md border-l-4 border-red-600{% endif %}">
            <i class="fas fa-calendar-times text-unirvBlue" aria-hidden="true"></i>
            <strong class="text-unirvBlue font-semibold">Encerramento:</strong> <time datetime="{{ edital.end_date|date:'Y-m-d' }}">{{ edital.end_date|date:"d/m/Y" }}</time>
            {% if edital.end_date|is_deadline_soon %}
                <span class="text-red-600 text-xs font-medium ml-2" aria-label="Prazo próximo">
                    <i class="fas fa-clock" aria-hidden="true"></i> Prazo próximo
                </span>
            {% endif %}
        </span>
        {% endif %}
        {% if edital.created_by %}
        <span class="flex items-center gap-2 text-sm text-gray-700">
            <i class="fas fa-user text-unirvBlue" aria-hidden="true"></i>
            <strong class="text-unirvBlue font-semibold">Criado por:</strong> {{ edital.created_by.username }}
        </span>
        {% endif %}
        <span class="flex items-center gap-2 text-sm text-gray-700">
            <i class="fas fa-calendar text-unirvBlue" aria-hidden="true"></i>
            <strong class="text-unirvBlue font-semibold">Atualizado:</strong> <time datetime="{{ edital.data_atualizacao|date:'Y-m-d' }}">{{ edital.data_atualizacao|date:"d/m/Y" }}</time>
        </span>
    </div>
</div>


{% if edital.objetivo_safe %}
<div class="bg-white p-6 rounded-xl shadow-sm mb-6" id="objetivo">
  <h3 class="text-unirvBlue text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-200">1. Objetivo do Edital</h3>
  {# SECURITY NOTE: objetivo_safe should be sanitized on the server side using bleach or similar #}
  {# to prevent XSS attacks. Ensure mark_safe is only used after proper HTML sanitization. #}
  <div class="prose">{{ edital.objetivo_safe }}</div>
</div>
{% endif %}

{% if edital.etapas_safe %}
<div class="bg-white p-6 rounded-xl shadow-sm mb-6" id="etapas">
  <h3 class="text-unirvBlue text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-200">2. Etapas do Edital</h3>
  {# SECURITY NOTE: All _safe fields should be sanitized server-side before mark_safe #}
  <div class="prose">{{ edital.etapas_safe }}</div>
</div>
{% endif %}

{% if edital.recursos_safe %}
<div class="bg-white p-6 rounded-xl shadow-sm mb-6" id="recursos-financeiros">
  <h3 class="text-unirvBlue text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-200">3. Cronograma / Recursos</h3>
  <div class="prose">{{ edital.recursos_safe }}</div>
</div>
{% endif %}

{% if edital.itens_financiaveis_safe or edital.criterios_elegibilidade_safe or edital.criterios_avaliacao_safe %}
<div class="bg-white p-6 rounded-xl shadow-sm mb-6" id="itens-financiaveis">
  <h3 class="text-unirvBlue text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-200">4. Itens Financiáveis / Elegibilidade / Avaliação</h3>
  {% if edital.itens_financiaveis_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Itens Financiáveis</h4>
    <div class="prose">{{ edital.itens_financiaveis_safe }}</div>
  {% endif %}
  {% if edital.criterios_elegibilidade_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Critérios de Elegibilidade</h4>
    <div class="prose">{{ edital.criterios_elegibilidade_safe }}</div>
  {% endif %}
  {% if edital.criterios_avaliacao_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Critérios de Avaliação</h4>
    <div class="prose">{{ edital.criterios_avaliacao_safe }}</div>
  {% endif %}
</div>
{% endif %}

{% if edital.itens_essenciais_observacoes_safe %}
<div class="bg-white p-6 rounded-xl shadow-sm mb-6" id="itens-essenciais">
  <h3 class="text-unirvBlue text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-200">5. Itens Essenciais / Observações</h3>
  <div class="prose">{{ edital.itens_essenciais_observacoes_safe }}</div>
</div>
{% endif %}

{% if edital.detalhes_unirv_safe %}
<div class="bg-white p-6 rounded-xl shadow-sm mb-6" id="pontos-unirv">
  <h3 class="text-unirvBlue text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-200">6. Pontos para a UniRV</h3>
  <div class="prose">{{ edital.detalhes_unirv_safe }}</div>
</div>
{% endif %}

    {% if edital.created_by or edital.updated_by %}
        <div class="activity-info">
            {% if edital.created_by %}
                <span class="created-by">
        <i class="fas fa-user-plus" aria-hidden="true"></i>
        Criado por <strong>{{ edital.created_by.username }}</strong> em {{ edital.data_criacao|date:"d/m/Y H:i" }}
    </span>
            {% endif %}
            {% if edital.updated_by and edital.updated_by != edital.created_by %}
                <span class="updated-by">
        <i class="fas fa-user-edit" aria-hidden="true"></i>
        Última atualização por <strong>{{ edital.updated_by.username }}</strong>
    </span>
            {% endif %}
        </div>
    {% endif %}

<p class="disclaimer">
    <i class="fas fa-info-circle" aria-hidden="true"></i>
    Consulte o edital oficial para detalhes completos.
</p>

<div class="share-section">
    <h3>Compartilhar</h3>
    <div class="share-buttons">
        {% with share_url=request.build_absolute_uri share_text=edital.titulo|urlencode %}
        <a href="https://wa.me/?text={{ share_text }}%20{{ share_url|urlencode }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="share-btn share-whatsapp"
           aria-label="Compartilhar no WhatsApp">
            <i class="fab fa-whatsapp" aria-hidden="true"></i> WhatsApp
        </a>
        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ share_url|urlencode }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="share-btn share-linkedin"
           aria-label="Compartilhar no LinkedIn">
            <i class="fab fa-linkedin" aria-hidden="true"></i> LinkedIn
        </a>
        <a href="https://twitter.com/intent/tweet?text={{ share_text|urlencode }}&url={{ share_url|urlencode }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="share-btn share-twitter"
           aria-label="Compartilhar no Twitter">
            <i class="fab fa-twitter" aria-hidden="true"></i> Twitter
        </a>
        <button onclick="navigator.clipboard.writeText('{{ request.build_absolute_uri }}'); showToast('Link copiado!', 'success');" 
                class="share-btn share-copy"
                aria-label="Copiar link">
            <i class="fas fa-copy" aria-hidden="true"></i> Copiar Link
        </button>
        {% endwith %}
    </div>
</div>

<div class="flex flex-wrap gap-3 mt-8">
  {% include "components/button.html" with href=edital.url type="primary" slot='<i class="fas fa-external-link-alt" aria-hidden="true"></i> Acessar Edital' attrs='target="_blank" rel="noopener noreferrer"' %}
  
  {% if user.is_authenticated and user.is_staff %}
    {% url 'edital_update' edital.pk as update_url %}
    {% include "components/button.html" with href=update_url type="secondary" slot='<i class="fas fa-edit" aria-hidden="true"></i> Editar' %}
  {% endif %}
  
  {% url 'editais_index' as index_url %}
  {% include "components/button.html" with href=index_url type="outline" slot='<i class="fas fa-arrow-left" aria-hidden="true"></i> Voltar' %}
</div>

{% if user.is_authenticated and user.is_staff %}
{% with history_entries=edital.history.all %}
{% if history_entries %}
<div class="history-section">
    <h3>Histórico de Alterações</h3>
    <div class="history-list">
        {% for entry in history_entries|slice:":10" %}
        <div class="history-item">
            <div class="history-header">
                <span class="history-action history-{{ entry.action }}">{{ entry.get_action_display }}</span>
                <span class="history-user">por {{ entry.user.username|default:"Sistema" }}</span>
                <time class="history-time" datetime="{{ entry.timestamp|date:'Y-m-d H:i' }}">
                    {{ entry.timestamp|date:"d/m/Y H:i" }}
                </time>
            </div>
            {% if entry.changes_summary %}
            <div class="history-changes">
                {% for field, values in entry.changes_summary.items %}
                <div class="history-change-item">
                    <strong>{{ field|title }}:</strong>
                    <span class="old-value">{{ values.old|truncatewords:10 }}</span>
                    <i class="fas fa-arrow-right" aria-hidden="true"></i>
                    <span class="new-value">{{ values.new|truncatewords:10 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endwith %}
{% endif %}
{% endblock %}
