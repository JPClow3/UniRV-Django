{% extends 'base.html' %}
{% load static editais_filters humanize %}

{% block title %}{{ edital.titulo }} - AgroHub UniRV{% endblock %}


{% block meta_description %}{{ edital.objetivo|truncatewords:30|striptags }} - Edital de fomento {% if edital.entidade_principal %}pela {{ edital.entidade_principal }}{% endif %}. Status: {{ edital.get_status_display }}.{% endblock %}

{% block og_title %}{{ edital.titulo }}{% endblock %}

{% block og_description %}{{ edital.objetivo|truncatewords:25|striptags }}{% endblock %}

{% block twitter_title %}{{ edital.titulo }} - AgroHub UniRV{% endblock %}

{% block twitter_description %}{{ edital.objetivo|truncatewords:25|striptags|default:"Edital de fomento disponível no AgroHub UniRV" }}{% endblock %}

{% block og_type %}article{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/detail.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Header -->
{% with subtitle=edital.objetivo|default:""|striptags|truncatewords:30|default:"Confira os detalhes completos deste edital e as oportunidades disponíveis." %}
{% include 'components/page_hero.html' with badge_label="Edital" title=edital.titulo subtitle=subtitle meta_template="components/hero_meta_edital.html" %}
{% endwith %}

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="max-w-6xl mx-auto">
  <div class="mb-4 flex justify-end no-print">
    <button type="button" id="print-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all">
      <i class="fas fa-print"></i>
      Imprimir
    </button>
  </div>

<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-8 border border-gray-100">
    <h2 class="text-unirvBlue text-xl font-bold mb-4">Informações do Edital</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% if edital.start_date %}
        <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-calendar-alt text-green-600" aria-hidden="true"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Abertura</p>
                <time datetime="{{ edital.start_date|date:'Y-m-d' }}" class="text-gray-900 font-semibold">{{ edital.start_date|date:"d/m/Y" }}</time>
            </div>
        </div>
        {% endif %}
        {% if edital.end_date %}
        <div class="flex items-center gap-3 p-4 {% if edital.end_date|is_deadline_soon %}bg-red-50 border border-red-200{% else %}bg-gray-50{% endif %} rounded-xl">
            <div class="w-10 h-10 {% if edital.end_date|is_deadline_soon %}bg-red-100{% else %}bg-orange-100{% endif %} rounded-lg flex items-center justify-center">
                <i class="fas fa-calendar-times {% if edital.end_date|is_deadline_soon %}text-red-600{% else %}text-orange-600{% endif %}" aria-hidden="true"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Encerramento</p>
                <time datetime="{{ edital.end_date|date:'Y-m-d' }}" class="text-gray-900 font-semibold">{{ edital.end_date|date:"d/m/Y" }}</time>
                {% if edital.end_date|is_deadline_soon %}
                <span class="text-red-600 text-xs font-medium block" aria-label="Prazo próximo">
                    <i class="fas fa-clock" aria-hidden="true"></i> Prazo próximo
                </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-sync-alt text-blue-600" aria-hidden="true"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wide">Atualizado</p>
                <time datetime="{{ edital.data_atualizacao|date:'Y-m-d' }}" class="text-gray-900 font-semibold">{{ edital.data_atualizacao|date:"d/m/Y" }}</time>
            </div>
        </div>
    </div>
</div>


{% if edital.objetivo_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="objetivo">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">1</span>
    Objetivo do Edital
  </h3>
  {# SECURITY NOTE: objetivo_safe should be sanitized on the server side using bleach or similar #}
  {# to prevent XSS attacks. Ensure mark_safe is only used after proper HTML sanitization. #}
  <div class="prose">{{ edital.objetivo_safe }}</div>
</div>
{% endif %}

{% if edital.etapas_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="etapas">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">2</span>
    Etapas do Edital
  </h3>
  {# SECURITY NOTE: All _safe fields should be sanitized server-side before mark_safe #}
  <div class="prose">{{ edital.etapas_safe }}</div>
</div>
{% endif %}

{% if edital.recursos_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="recursos-financeiros">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">3</span>
    Cronograma / Recursos
  </h3>
  <div class="prose">{{ edital.recursos_safe }}</div>
</div>
{% endif %}

{% if edital.itens_financiaveis_safe or edital.criterios_elegibilidade_safe or edital.criterios_avaliacao_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="itens-financiaveis">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">4</span>
    Itens Financiáveis / Elegibilidade / Avaliação
  </h3>
  {% if edital.itens_financiaveis_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Itens Financiáveis</h4>
    <div class="prose">{{ edital.itens_financiaveis_safe }}</div>
  {% endif %}
  {% if edital.criterios_elegibilidade_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Critérios de Elegibilidade</h4>
    <div class="prose">{{ edital.criterios_elegibilidade_safe }}</div>
  {% endif %}
  {% if edital.criterios_avaliacao_safe %}
    <h4 class="text-blue-900 text-lg font-semibold mt-6 mb-3">Critérios de Avaliação</h4>
    <div class="prose">{{ edital.criterios_avaliacao_safe }}</div>
  {% endif %}
</div>
{% endif %}

{% if edital.itens_essenciais_observacoes_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="itens-essenciais">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">5</span>
    Itens Essenciais / Observações
  </h3>
  <div class="prose">{{ edital.itens_essenciais_observacoes_safe }}</div>
</div>
{% endif %}

{% if edital.detalhes_unirv_safe %}
<div class="bg-white p-6 md:p-8 rounded-xl shadow-sm mb-6 border border-gray-100" id="pontos-unirv">
  <h3 class="text-unirvBlue text-xl md:text-2xl font-bold mb-5 pb-3 border-b-2 border-gray-100 flex items-center gap-3">
    <span class="w-8 h-8 bg-unirvBlue text-white rounded-lg flex items-center justify-center text-sm font-bold">6</span>
    Pontos para a UniRV
  </h3>
  <div class="prose">{{ edital.detalhes_unirv_safe }}</div>
</div>
{% endif %}

    {% if edital.created_by or edital.updated_by %}
        <div class="activity-info">
            {% if edital.created_by %}
                <span class="created-by">
        <i class="fas fa-user-plus" aria-hidden="true"></i>
        Criado por <strong>{{ edital.created_by.username }}</strong> em {{ edital.data_criacao|date:"d/m/Y H:i" }}
    </span>
            {% endif %}
            {% if edital.updated_by and edital.updated_by != edital.created_by %}
                <span class="updated-by">
        <i class="fas fa-user-edit" aria-hidden="true"></i>
        Última atualização por <strong>{{ edital.updated_by.username }}</strong>
    </span>
            {% endif %}
        </div>
    {% endif %}

<p class="disclaimer">
    <i class="fas fa-info-circle" aria-hidden="true"></i>
    Consulte o edital oficial para detalhes completos.
</p>

<div class="flex flex-wrap gap-3 mt-8">
  {% include "components/button.html" with href=edital.url type="primary" icon="fas fa-external-link-alt" slot="Acessar Edital" target="_blank" rel="noopener noreferrer" %}
  
  {% if user.is_authenticated and user.is_staff %}
    {% url 'edital_update' edital.pk as update_url %}
    {% include "components/button.html" with href=update_url type="secondary" icon="fas fa-edit" slot="Editar" %}
  {% endif %}
  
  {% url 'editais_index' as index_url %}
  {% include "components/button.html" with href=index_url type="outline" icon="fas fa-arrow-left" slot="Voltar" %}
</div>

{% if user.is_authenticated and user.is_staff %}
{% with history_entries=edital.history.all %}
{% if history_entries %}
<div class="history-section">
    <h3>Histórico de Alterações</h3>
    <div class="history-list">
        {% for entry in history_entries|slice:":10" %}
        <div class="history-item">
            <div class="history-header">
                <span class="history-action history-{{ entry.action }}">{{ entry.get_action_display }}</span>
                <span class="history-user">por {{ entry.user.username|default:"Sistema" }}</span>
                <time class="history-time" datetime="{{ entry.timestamp|date:'Y-m-d H:i' }}">
                    {{ entry.timestamp|date:"d/m/Y H:i" }}
                </time>
            </div>
            {% if entry.changes_summary %}
            <div class="history-changes">
                {% for field, values in entry.changes_summary.items %}
                <div class="history-change-item">
                    <strong>{{ field|title }}:</strong>
                    <span class="old-value">{{ values.old|truncatewords:10 }}</span>
                    <i class="fas fa-arrow-right" aria-hidden="true"></i>
                    <span class="new-value">{{ values.new|truncatewords:10 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endwith %}
{% endif %}

  </div><!-- end max-w-6xl -->
</div><!-- end container -->
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/detail.js' %}" defer></script>
{% endblock %}
