{% extends 'base.html' %}
{% load editais_filters %}

{% block title %}{{ edital.titulo }} - AgroHub UniRV{% endblock %}

{% block breadcrumb %}
{% include 'editais/breadcrumb.html' %}
{% block breadcrumb_items %}
<li class="breadcrumb-item" aria-current="page">
    <span>{{ edital.titulo|truncatewords:8 }}</span>
</li>
{% endblock %}
{% endblock %}

{% block meta_description %}{{ edital.objetivo|truncatewords:30|striptags }} - Edital de fomento {% if edital.entidade_principal %}pela {{ edital.entidade_principal }}{% endif %}. Status: {{ edital.get_status_display }}.{% endblock %}

{% block og_title %}{{ edital.titulo }}{% endblock %}

{% block og_description %}{{ edital.objetivo|truncatewords:25|striptags }}{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        {% csrf_token %}
    {% endif %}

<div class="page-header">
    <div class="page-header-top">
        <h1>{{ edital.titulo }}</h1>
    </div>
    <div class="page-meta">
        {% if edital.numero_edital %}
        <span class="page-meta-item">
            <i class="fas fa-file-alt" aria-hidden="true"></i>
            <strong>Nº:</strong> {{ edital.numero_edital }}
        </span>
        {% endif %}
        {% if edital.entidade_principal %}
        <span class="page-meta-item">
            <i class="fas fa-building" aria-hidden="true"></i>
            <strong>Entidade:</strong> {{ edital.entidade_principal }}
        </span>
        {% endif %}
        <span class="page-meta-item">
            <i class="fas fa-tag" aria-hidden="true"></i>
            <strong>Status:</strong> <span class="status-badge status-{{ edital.status }}">{{ edital.get_status_display }}</span>
        </span>
        {% if edital.start_date %}
        <span class="page-meta-item">
            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
            <strong>Abertura:</strong> <time datetime="{{ edital.start_date|date:'Y-m-d' }}">{{ edital.start_date|date:"d/m/Y" }}</time>
        </span>
        {% endif %}
        {% if edital.end_date %}
        <span class="page-meta-item {% if edital.end_date|is_deadline_soon %}deadline-soon-meta{% endif %}">
            <i class="fas fa-calendar-times" aria-hidden="true"></i>
            <strong>Encerramento:</strong> <time datetime="{{ edital.end_date|date:'Y-m-d' }}">{{ edital.end_date|date:"d/m/Y" }}</time>
            {% if edital.end_date|is_deadline_soon %}
                <span class="deadline-warning" aria-label="Prazo próximo">
                    <i class="fas fa-clock" aria-hidden="true"></i> Prazo próximo
                </span>
            {% endif %}
        </span>
        {% endif %}
        {% if edital.created_by %}
        <span class="page-meta-item">
            <i class="fas fa-user" aria-hidden="true"></i>
            <strong>Criado por:</strong> {{ edital.created_by.username }}
        </span>
        {% endif %}
        <span class="page-meta-item">
            <i class="fas fa-calendar" aria-hidden="true"></i>
            <strong>Atualizado:</strong> <time datetime="{{ edital.data_atualizacao|date:'Y-m-d' }}">{{ edital.data_atualizacao|date:"d/m/Y" }}</time>
        </span>
    </div>
</div>


{% if edital.objetivo_safe %}
<div class="edital-section" id="objetivo">
  <h3>1. Objetivo do Edital</h3>
  <div class="prose">{{ edital.objetivo_safe }}</div>
</div>
{% endif %}

{% if edital.etapas_safe %}
<div class="edital-section" id="etapas">
  <h3>2. Etapas do Edital</h3>
  <div class="prose">{{ edital.etapas_safe }}</div>
</div>
{% endif %}

{% if edital.recursos_safe %}
<div class="edital-section" id="recursos-financeiros">
  <h3>3. Cronograma / Recursos</h3>
  <div class="prose">{{ edital.recursos_safe }}</div>
</div>
{% endif %}

{% if edital.itens_financiaveis_safe or edital.criterios_elegibilidade_safe or edital.criterios_avaliacao_safe %}
<div class="edital-section" id="itens-financiaveis">
  <h3>4. Itens Financiáveis / Elegibilidade / Avaliação</h3>
  {% if edital.itens_financiaveis_safe %}
    <h4>Itens Financiáveis</h4>
    <div class="prose">{{ edital.itens_financiaveis_safe }}</div>
  {% endif %}
  {% if edital.criterios_elegibilidade_safe %}
    <h4>Critérios de Elegibilidade</h4>
    <div class="prose">{{ edital.criterios_elegibilidade_safe }}</div>
  {% endif %}
  {% if edital.criterios_avaliacao_safe %}
    <h4>Critérios de Avaliação</h4>
    <div class="prose">{{ edital.criterios_avaliacao_safe }}</div>
  {% endif %}
</div>
{% endif %}

{% if edital.itens_essenciais_observacoes_safe %}
<div class="edital-section" id="itens-essenciais">
  <h3>5. Itens Essenciais / Observações</h3>
  <div class="prose">{{ edital.itens_essenciais_observacoes_safe }}</div>
</div>
{% endif %}

{% if edital.detalhes_unirv_safe %}
<div class="edital-section" id="pontos-unirv">
  <h3>6. Pontos para a UniRV</h3>
  <div class="prose">{{ edital.detalhes_unirv_safe }}</div>
</div>
{% endif %}

    {% if edital.created_by or edital.updated_by %}
        <div class="activity-info">
            {% if edital.created_by %}
                <span class="created-by">
        <i class="fas fa-user-plus" aria-hidden="true"></i>
        Criado por <strong>{{ edital.created_by.username }}</strong> em {{ edital.data_criacao|date:"d/m/Y H:i" }}
    </span>
            {% endif %}
            {% if edital.updated_by and edital.updated_by != edital.created_by %}
                <span class="updated-by">
        <i class="fas fa-user-edit" aria-hidden="true"></i>
        Última atualização por <strong>{{ edital.updated_by.username }}</strong>
    </span>
            {% endif %}
        </div>
    {% endif %}

<p class="disclaimer">
    <i class="fas fa-info-circle" aria-hidden="true"></i>
    Consulte o edital oficial para detalhes completos.
</p>

<div class="share-section">
    <h3>Compartilhar</h3>
    <div class="share-buttons">
        {% with share_url=request.build_absolute_uri share_text=edital.titulo|urlencode %}
        <a href="https://wa.me/?text={{ share_text }}%20{{ share_url|urlencode }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="share-btn share-whatsapp"
           aria-label="Compartilhar no WhatsApp">
            <i class="fab fa-whatsapp" aria-hidden="true"></i> WhatsApp
        </a>
        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ share_url|urlencode }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="share-btn share-linkedin"
           aria-label="Compartilhar no LinkedIn">
            <i class="fab fa-linkedin" aria-hidden="true"></i> LinkedIn
        </a>
        <a href="https://twitter.com/intent/tweet?text={{ share_text|urlencode }}&url={{ share_url|urlencode }}" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="share-btn share-twitter"
           aria-label="Compartilhar no Twitter">
            <i class="fab fa-twitter" aria-hidden="true"></i> Twitter
        </a>
        <button onclick="navigator.clipboard.writeText('{{ request.build_absolute_uri }}'); showToast('Link copiado!', 'success');" 
                class="share-btn share-copy"
                aria-label="Copiar link">
            <i class="fas fa-copy" aria-hidden="true"></i> Copiar Link
        </button>
        {% endwith %}
    </div>
</div>

<div class="detail-actions">
  <a href="{{ edital.url }}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
      <i class="fas fa-external-link-alt" aria-hidden="true"></i> Acessar Edital
  </a>
  {% if user.is_authenticated and user.is_staff %}
  <a href="{% url 'edital_update' edital.pk %}" class="btn btn-secondary">
      <i class="fas fa-edit" aria-hidden="true"></i> Editar
  </a>
  {% endif %}
  <a href="{% url 'editais_index' %}" class="btn btn-outline">
      <i class="fas fa-arrow-left" aria-hidden="true"></i> Voltar
  </a>
</div>

{% if user.is_authenticated and user.is_staff %}
{% with history_entries=edital.history.all %}
{% if history_entries %}
<div class="history-section">
    <h3>Histórico de Alterações</h3>
    <div class="history-list">
        {% for entry in history_entries|slice:":10" %}
        <div class="history-item">
            <div class="history-header">
                <span class="history-action history-{{ entry.action }}">{{ entry.get_action_display }}</span>
                <span class="history-user">por {{ entry.user.username|default:"Sistema" }}</span>
                <time class="history-time" datetime="{{ entry.timestamp|date:'Y-m-d H:i' }}">
                    {{ entry.timestamp|date:"d/m/Y H:i" }}
                </time>
            </div>
            {% if entry.changes_summary %}
            <div class="history-changes">
                {% for field, values in entry.changes_summary.items %}
                <div class="history-change-item">
                    <strong>{{ field|title }}:</strong>
                    <span class="old-value">{{ values.old|truncatewords:10 }}</span>
                    <i class="fas fa-arrow-right" aria-hidden="true"></i>
                    <span class="new-value">{{ values.new|truncatewords:10 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endwith %}
{% endif %}
{% endblock %}
