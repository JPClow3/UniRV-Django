{% extends 'base.html' %}
{% load editais_filters %}

{% block title %}Editais de Fomento - AgroHub UniRV{% endblock %}

{% block breadcrumb %}
{% include 'editais/breadcrumb.html' %}
{% block breadcrumb_items %}
<li class="breadcrumb-item" aria-current="page">
    <span>Lista de Editais</span>
</li>
{% endblock %}
{% endblock %}

{% block meta_description %}Explore editais de fomento abertos para o agronegócio. Encontre oportunidades de financiamento, pesquisa e inovação para seu projeto.{% endblock %}

{% block meta_keywords %}editais fomento, agronegócio, financiamento rural, pesquisa agrícola, inovação, UniRV{% endblock %}

{% block content %}
<div class="editais-header">
    <div class="search-section">
        <div class="search-header">
            <div class="title-group">
                <h1 class="main-title">Editais de Fomento</h1>
                <p class="search-subtitle">
                    Encontramos <strong>{{ total_count }}</strong> 
                    edita{{ total_count|pluralize:"l,is" }}
                </p>
            </div>

            <div class="header-actions">
                {% if user.is_authenticated and user.is_staff %}
                <a href="{% url 'edital_create' %}" 
                   class="btn btn-primary"
                   title="Criar novo edital"
                   aria-label="Criar novo edital">
                    <i class="fas fa-plus" aria-hidden="true"></i>
                    Criar Edital
                </a>
                <a href="{% url 'admin_dashboard' %}" 
                   class="btn-icon btn-icon-primary"
                   title="Acessar dashboard administrativo"
                   aria-label="Acessar dashboard administrativo">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    <span class="sr-only">Dashboard</span>
                </a>
                {% endif %}
            </div>
        </div>

        <div class="filters-container">
            <form method="GET" class="search-form" role="search" aria-label="Buscar editais">
                <div class="search-input-row">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search search-icon" aria-hidden="true"></i>
                        <input type="text" 
                            name="search" 
                            value="{{ search_query }}"
                            placeholder="Buscar por título, entidade ou número do edital..." 
                            class="search-input"
                            aria-label="Campo de busca"
                            autocomplete="off">
                        {% if search_query %}
                            <button type="button" class="search-clear" aria-label="Limpar busca">
                                <i class="fas fa-times" aria-hidden="true"></i>
                            </button>
                        {% else %}
                            <div class="keyboard-hint" aria-hidden="true">
                                <kbd>Ctrl</kbd> + <kbd>K</kbd>
                            </div>
                        {% endif %}
                    </div>
                    <button type="submit" class="search-submit" aria-label="Buscar editais">
                        <i class="fas fa-search" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label class="sr-only" for="status-filter">Filtrar por status</label>
                        <select id="status-filter" name="status" class="status-filter" aria-label="Filtrar por status">
                            <option value="">Todos os Status</option>
                            {% for value, display in status_choices %}
                                <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="start_date-filter" class="filter-label">Data de Abertura:</label>
                        <input type="date" 
                               id="start_date-filter" 
                               name="start_date" 
                               value="{{ start_date_filter }}"
                               class="date-filter"
                               aria-label="Filtrar por data de abertura">
                    </div>
                    
                    <div class="filter-group">
                        <label for="end_date-filter" class="filter-label">Data de Encerramento:</label>
                        <input type="date" 
                               id="end_date-filter" 
                               name="end_date" 
                               value="{{ end_date_filter }}"
                               class="date-filter"
                               aria-label="Filtrar por data de encerramento">
                    </div>
                    
                    <div class="filter-group">
                        <label class="checkbox-filter">
                            <input type="checkbox" 
                                   name="only_open" 
                                   value="1"
                                   {% if only_open %}checked{% endif %}
                                   aria-label="Mostrar somente editais abertos">
                            <span>Somente Abertos</span>
                        </label>
                    </div>
                </div>
            </form>

        </div>

        <!-- Active filters display -->
    {% if search_query or status_filter or start_date_filter or end_date_filter or only_open %}
        <div class="active-filters">
            <span class="active-filters-label">Filtros ativos:</span>
            {% if search_query %}
                <span class="filter-tag">
                    Busca: "{{ search_query }}"
                    <a href="?{% preserve_filters request search='' %}" class="filter-remove" aria-label="Remover filtro de busca">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </a>
                </span>
            {% endif %}
            {% if status_filter %}
                <span class="filter-tag">
                    Status: {{ status_filter|title }}
                    <a href="?{% preserve_filters request status='' %}" class="filter-remove" aria-label="Remover filtro de status">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </a>
                </span>
            {% endif %}
            {% if start_date_filter %}
                <span class="filter-tag">
                    Abertura: {{ start_date_filter }}
                    <a href="?{% preserve_filters request start_date='' %}" class="filter-remove" aria-label="Remover filtro de data de abertura">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </a>
                </span>
            {% endif %}
            {% if end_date_filter %}
                <span class="filter-tag">
                    Encerramento: {{ end_date_filter }}
                    <a href="?{% preserve_filters request end_date='' %}" class="filter-remove" aria-label="Remover filtro de data de encerramento">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </a>
                </span>
            {% endif %}
            {% if only_open %}
                <span class="filter-tag">
                    Somente Abertos
                    <a href="?{% preserve_filters request only_open='' %}" class="filter-remove" aria-label="Remover filtro somente abertos">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </a>
                </span>
            {% endif %}
            <a href="{% url 'editais_index' %}" class="filter-clear-all">
                <i class="fas fa-redo" aria-hidden="true"></i>
                Limpar todos
            </a>
        </div>
    {% endif %}
</div>

<div class="editais-grid" aria-label="Lista de editais">
    {% for edital in page_obj %}
        <article class="edital-card">
            <div class="card-header">
                <span class="status-badge status-{{ edital.status }}" aria-label="Status do edital">{{ edital.get_status_display }}</span>
                {% if edital.numero_edital %}
                    <span class="edital-number">{{ edital.numero_edital }}</span>
                {% endif %}
            </div>

            <h2 class="edital-title">
                <a href="{{ edital.get_absolute_url }}">{{ edital.titulo|truncatewords:12 }}</a>
            </h2>

            <div class="card-meta">
                {% if edital.entidade_principal %}
                    <div class="card-meta-item">
                        <i class="fas fa-building" aria-hidden="true"></i>
                        <span class="meta-label">Instituição:</span>
                        <span class="meta-value">{{ edital.entidade_principal }}</span>
                    </div>
                {% endif %}
                
                <div class="card-meta-item">
                    <i class="fas fa-tag" aria-hidden="true"></i>
                    <span class="meta-label">Status:</span>
                    <span class="meta-value status-text status-{{ edital.status }}">{{ edital.get_status_display }}</span>
                </div>
                
                {% if edital.valores.exists %}
                    {% with primeiro_valor=edital.valores.first %}
                        {% if primeiro_valor.valor_total %}
                            <div class="card-meta-item">
                                <i class="fas fa-dollar-sign" aria-hidden="true"></i>
                                <span class="meta-label">Valor:</span>
                                <span class="meta-value">
                                    {% if primeiro_valor.moeda == 'BRL' %}R${% elif primeiro_valor.moeda == 'USD' %}US${% elif primeiro_valor.moeda == 'EUR' %}€{% endif %}
                                    {{ primeiro_valor.valor_total|floatformat:2 }}
                                </span>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>

            <p class="edital-objective">
                {{ edital.objetivo|default_if_none:''|truncatewords:25|default:"Sem descrição disponível." }}
            </p>

            <div class="card-footer">
                <div class="card-dates">
                    {% if edital.start_date %}
                    <div class="date-item">
                        <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                        <span class="date-label">Abertura:</span>
                        <time datetime="{{ edital.start_date|date:'Y-m-d' }}" class="date-value">
                            {{ edital.start_date|date:"d/m/Y" }}
                        </time>
                    </div>
                    {% elif edital.data_criacao %}
                    <div class="date-item">
                        <i class="fas fa-calendar-plus" aria-hidden="true"></i>
                        <span class="date-label">Criado em:</span>
                        <time datetime="{{ edital.data_criacao|date:'Y-m-d' }}" class="date-value">
                            {{ edital.data_criacao|date:"d/m/Y" }}
                        </time>
                    </div>
                    {% endif %}
                    
                    {% if edital.end_date %}
                    <div class="date-item {% if edital.end_date|is_deadline_soon %}deadline-soon{% endif %}">
                        <i class="fas fa-calendar-times" aria-hidden="true"></i>
                        <span class="date-label">Encerra:</span>
                        <time datetime="{{ edital.end_date|date:'Y-m-d' }}" class="date-value">
                            {{ edital.end_date|date:"d/m/Y" }}
                        </time>
                        {% if edital.end_date|is_deadline_soon %}
                            <span class="deadline-warning" aria-label="Prazo próximo">
                                <i class="fas fa-clock" aria-hidden="true"></i> Prazo próximo
                            </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if edital.data_atualizacao %}
                    <div class="date-item update-date">
                        <i class="fas fa-sync-alt" aria-hidden="true"></i>
                        <span class="date-label">Atualizado:</span>
                        <time datetime="{{ edital.data_atualizacao|date:'Y-m-d' }}" class="date-value">
                            {{ edital.data_atualizacao|date:"d/m/Y" }}
                        </time>
                    </div>
                    {% endif %}
                </div>

                <div class="card-actions">
                    <a href="{{ edital.get_absolute_url }}" class="btn btn-ghost" aria-label="Ver detalhes de {{ edital.titulo }}">
                        Ver Detalhes
                    </a>
                    {% if user.is_authenticated and user.is_staff %}
                    <a href="{% url 'edital_update' edital.pk %}" class="btn btn-ghost-secondary" aria-label="Editar {{ edital.titulo }}">
                        Editar
                    </a>
                    {% endif %}
                </div>
            </div>
        </article>
    {% empty %}
        <div class="empty-state" role="status">
            <div class="empty-state-icon">
                <i class="fas fa-search" aria-hidden="true"></i>
            </div>
            <h3>Nenhum edital encontrado</h3>
            {% if search_query or status_filter %}
                <p>Não encontramos editais que correspondam aos seus filtros. Tente ajustar sua busca ou remover os filtros aplicados.</p>
                <div class="empty-state-actions">
                    <a href="{% url 'editais_index' %}" class="btn btn-outline">
                        <i class="fas fa-redo" aria-hidden="true"></i> Limpar Filtros
                    </a>
                    {% if user.is_authenticated and user.is_staff %}
                    <a href="{% url 'admin_dashboard' %}" class="btn btn-primary">
                        <i class="fas fa-chart-line" aria-hidden="true"></i> Acessar Dashboard
                    </a>
                    {% endif %}
                </div>
            {% else %}
                <p>Ainda não há editais cadastrados no sistema. Seja o primeiro a adicionar um edital de fomento!</p>
                <div class="empty-state-actions">
                    {% if user.is_authenticated and user.is_staff %}
                    <a href="{% url 'admin_dashboard' %}" class="btn btn-primary">
                        <i class="fas fa-chart-line" aria-hidden="true"></i> Acessar Dashboard
                    </a>
                    {% elif user.is_authenticated %}
                    <a href="{% url 'admin:login' %}" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i> Fazer Login para Cadastrar
                    </a>
                    {% else %}
                    <a href="{% url 'admin:login' %}" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt" aria-hidden="true"></i> Fazer Login para Cadastrar
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>

{% if page_obj.has_other_pages %}
    <nav class="pagination-container" aria-label="Navegação de páginas">
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?{% preserve_filters request page=1 %}" class="page-link" aria-label="Ir para primeira página">&laquo; Primeira</a>
                <a href="?{% preserve_filters request page=page_obj.previous_page_number %}" class="page-link" aria-label="Ir para página anterior">Anterior</a>
            {% endif %}

            <!-- A11Y-004: Indicador de página atual com aria-current -->
            <span class="page-info" aria-current="page" aria-label="Página atual, página {{ page_obj.number }}">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?{% preserve_filters request page=page_obj.next_page_number %}" class="page-link" aria-label="Ir para próxima página">Próxima</a>
                <a href="?{% preserve_filters request page=page_obj.paginator.num_pages %}" class="page-link" aria-label="Ir para última página">Última &raquo;</a>
            {% endif %}
        </div>
    </nav>
{% endif %}
{% endblock %}

