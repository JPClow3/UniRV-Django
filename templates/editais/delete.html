{% extends 'base.html' %}
{% load editais_filters %}

{% block title %}Excluir Edital - AgroHub UniRV{% endblock %}

{% block content %}
<div class="form-page">
    <div class="form-header">
        <h1>Confirmar Exclusão</h1>
        <p class="form-subtitle">Esta ação não pode ser desfeita</p>
    </div>
    
    <div class="delete-warning" role="alert">
        <div class="delete-warning-icon">
            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
        </div>
        <div class="delete-warning-content">
            <h2>Tem certeza que deseja excluir este edital?</h2>
            <p class="delete-warning-title">
                <strong>"{{ edital.titulo }}"</strong>
            </p>
            <!-- Store edital title in data attribute for safe retrieval in JavaScript -->
            <span id="edital-title-data" data-edital-title="{{ edital.titulo }}" style="display: none;"></span>
            <p class="warning-text">
                <i class="fas fa-info-circle" aria-hidden="true"></i>
                Todos os dados relacionados serão permanentemente removidos, incluindo:
            </p>
            <ul class="warning-list">
                <li>Cronogramas associados</li>
                <li>Valores financeiros registrados</li>
                <li>Histórico de alterações</li>
            </ul>
        </div>
    </div>
    
    <form method="post" class="delete-form" id="delete-form">
        {% csrf_token %}
        <div class="form-actions">
            <button type="button" class="btn btn-danger" id="delete-confirm-btn">
                <i class="fas fa-trash" aria-hidden="true"></i>
                <span>Confirmar Exclusão</span>
            </button>
            <a href="{{ edital.get_absolute_url }}" class="btn btn-secondary">
                <i class="fas fa-times" aria-hidden="true"></i>
                Cancelar
            </a>
        </div>
    </form>

<script>
async function confirmDelete() {
    // Safely retrieve edital title from data attribute with fallback
    const titleElement = document.getElementById('edital-title-data');
    const titleStrongElement = document.querySelector('.delete-warning-title strong');
    
    // Try to get title from data attribute first, then fallback to DOM textContent
    let editalTitle = '';
    if (titleElement && titleElement.getAttribute('data-edital-title')) {
        editalTitle = titleElement.getAttribute('data-edital-title');
    } else if (titleStrongElement && titleStrongElement.textContent) {
        // Remove surrounding quotes if present
        editalTitle = titleStrongElement.textContent.trim().replace(/^"|"$/g, '');
    } else {
        // Last resort fallback
        editalTitle = 'este edital';
    }
    
    // Escape the edital title to prevent XSS attacks and template literal injection
    // This prevents injection via backticks, ${}, and other template literal syntax
    const escapedTitle = escapeJsString(editalTitle);
    
    const confirmed = await showConfirmDialog({
        title: 'Confirmar Exclusão',
        // IMPORTANT: Use regular string concatenation, not template literals here
        message: 'Tem certeza que deseja excluir o edital "' + escapedTitle + '"? Esta ação não pode ser desfeita.',
        confirmText: 'Excluir',
        cancelText: 'Cancelar',
        type: 'danger',
        confirmButtonClass: 'btn-danger'
    });
    
    if (confirmed) {
        const form = document.getElementById('delete-form');
        if (form) {
            form.submit();
        }
    }
}

// Add event listener for delete button
document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('delete-confirm-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', confirmDelete);
    }
});
</script>
</div>
{% endblock %}

