name: Tests and Coverage

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DJANGO_DEBUG: 'True'
      ALLOWED_HOSTS: 'localhost,127.0.0.1'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set environment variables
        run: |
          SECRET_KEY="${SECRET_KEY:-dummy-secret-key-for-ci}"
          echo "SECRET_KEY=$SECRET_KEY" >> $GITHUB_ENV
          echo "Environment variables set:"
          echo "  SECRET_KEY: ${SECRET_KEY:0:10}..."
          echo "  DJANGO_DEBUG: $DJANGO_DEBUG"
          echo "  ALLOWED_HOSTS: $ALLOWED_HOSTS"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run linting (ruff)
        run: |
          echo "Running ruff linter..."
          ruff check editais/ UniRV_Django/ --output-format=github
          echo "Linting completed"

      - name: Run security scan (bandit)
        run: |
          echo "Running bandit security scan..."
          bandit -r editais/ UniRV_Django/ -ll -ii --format txt
          echo "Security scan completed"

      - name: Run database migrations
        run: |
          echo "Running database migrations..."
          python manage.py migrate --noinput
          echo "Migrations completed successfully"

      - name: Run tests with coverage
        run: |
          echo "Running tests with coverage..."
          coverage run --source='editais' manage.py test
          echo "Tests completed"

      - name: Generate coverage report
        run: |
          coverage report
          coverage xml
          coverage html

      - name: Check coverage threshold
        run: |
          echo "Checking coverage threshold (80%)..."
          coverage report --fail-under=80

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.xml
          retention-days: 7

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            // Get PR number from context
            const prNumber = context.payload.pull_request?.number || context.issue?.number;
            
            if (!prNumber) {
              console.log('No PR number found, skipping comment');
              return;
            }
            
            try {
              // Get coverage summary
              const coverageOutput = execSync('coverage report', { encoding: 'utf-8' });
              const lines = coverageOutput.split('\n');
              
              // Find the total line
              const totalLine = lines.find(line => line.includes('TOTAL'));
              let coveragePercent = 'N/A';
              
              if (totalLine) {
                const parts = totalLine.split(/\s+/);
                // Coverage percentage is usually in the last column
                coveragePercent = parts[parts.length - 1] || 'N/A';
              }
              
              const comment = `## Test Coverage Report
              
              Coverage: **${coveragePercent}**
              
              Full coverage report is available in the workflow artifacts.
              
              Threshold: 80% (enforced in CI)`;
              
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              console.log(`Successfully commented on PR #${prNumber}`);
            } catch (error) {
              console.error('Error creating comment:', error.message);
              // Don't fail the workflow if commenting fails
            }
