name: Lighthouse CI

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allow manual triggering

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    env:
      DJANGO_DEBUG: 'True'
      ALLOWED_HOSTS: 'localhost,127.0.0.1'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}"
          if [ -z "$SECRET_KEY" ]; then
            SECRET_KEY="dummy-secret-key-for-ci"
          fi
          echo "SECRET_KEY=$SECRET_KEY" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: theme/static_src/package.json

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node.js dependencies
        run: |
          cd theme/static_src
          npm ci

      - name: Run database migrations
        run: |
          python manage.py migrate --noinput

      - name: Collect static files
        run: |
          python manage.py collectstatic --noinput

      - name: Start Django server
        run: |
          python manage.py runserver 127.0.0.1:7000 --noreload > /tmp/django-server.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          sleep 10

      - name: Wait for server and check status
        run: |
          echo "Waiting for server to be ready..."
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:7000/health/ 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Server is ready! Health check passed (HTTP $HTTP_CODE)."
              curl -s http://127.0.0.1:7000/health/ | head -5
              echo ""
              echo "Testing root URL..."
              ROOT_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:7000/ 2>/dev/null || echo "000")
              echo "Root URL returned HTTP $ROOT_CODE"
              if [ "$ROOT_CODE" != "200" ] && [ "$ROOT_CODE" != "000" ]; then
                echo "Warning: Root URL returned $ROOT_CODE, but continuing..."
              fi
              exit 0
            fi
            echo "Attempt $i/30: Server returned HTTP $HTTP_CODE, waiting..."
            sleep 2
          done
          echo "Server health check failed after 60 seconds. Showing diagnostics:"
          echo "=== Server Logs (last 50 lines) ==="
          tail -50 /tmp/django-server.log 2>/dev/null || echo "No server logs found"
          echo ""
          echo "=== Server Process Check ==="
          ps aux | grep -E "[r]unserver" || echo "No runserver process found"
          echo ""
          echo "=== Port Check ==="
          netstat -tlnp 2>/dev/null | grep 7000 || ss -tlnp 2>/dev/null | grep 7000 || echo "Port 7000 not listening"
          echo ""
          echo "=== Test Health Endpoint ==="
          curl -v http://127.0.0.1:7000/health/ 2>&1 | head -20
          exit 1

      - name: Run Lighthouse CI
        run: |
          npx @lhci/cli autorun --config=.lighthouserc.js
        env:
          # Optional: Override thresholds via environment variables
          LHCI_PERFORMANCE_THRESHOLD: ${{ env.LHCI_PERFORMANCE_THRESHOLD || '0.80' }}
          LHCI_ACCESSIBILITY_THRESHOLD: ${{ env.LHCI_ACCESSIBILITY_THRESHOLD || '0.90' }}
          LHCI_BEST_PRACTICES_THRESHOLD: ${{ env.LHCI_BEST_PRACTICES_THRESHOLD || '0.90' }}
          LHCI_SEO_THRESHOLD: ${{ env.LHCI_SEO_THRESHOLD || '0.90' }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: lighthouse_reports/
          retention-days: 7

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Try to read lighthouse results
            const reportsDir = 'lighthouse_reports';
            if (fs.existsSync(reportsDir)) {
              const files = fs.readdirSync(reportsDir);
              const jsonFiles = files.filter(f => f.endsWith('.json'));
              
              if (jsonFiles.length > 0) {
                // Read the first JSON report
                const reportPath = path.join(reportsDir, jsonFiles[0]);
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                // Extract scores
                const categories = report.categories || {};
                const performance = Math.round((categories.performance?.score || 0) * 100);
                const accessibility = Math.round((categories.accessibility?.score || 0) * 100);
                const bestPractices = Math.round((categories['best-practices']?.score || 0) * 100);
                const seo = Math.round((categories.seo?.score || 0) * 100);
                
                const comment = `## Lighthouse CI Results
                
                | Category | Score |
                |----------|-------|
                | Performance | ${performance} |
                | Accessibility | ${accessibility} |
                | Best Practices | ${bestPractices} |
                | SEO | ${seo} |
                
                Full reports are available in the workflow artifacts.`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }

